# 비전 통합 미션 컨트롤러 사용 가이드

## 개요
이 미션 컨트롤러는 로봇 팔 제어와 비전 검사를 통합하여 총기 및 탄창 관리 프로세스를 자동화합니다.

## 주요 기능

### 1. 비전 검사 통합
- **QR 코드 인식**: 총기의 QR 코드를 읽고 지정된 값과 일치하는지 확인
- **조정간 안전 검사**: YOLO 모델로 조정간이 SAFE 상태인지 확인
- **탄창 방향 검사**: 탄창이 우상탄 상태인지 확인 (좌상탄 감지 시 프로세스 정지)

### 2. 프로세스 모드
- **불입(IN)**: 총기와 탄창을 레일에서 회수하여 보관함에 반납
- **불출(OUT)**: 총기와 탄창을 보관함에서 꺼내 레일에 배치

### 3. 자동 안전 조치
- QR 불일치 시: 자동으로 총기를 레일로 반출
- 조정간 비안전 상태: 자동으로 총기를 레일로 반출
- 탄창 좌상탄 감지: 프로세스 정지 및 경고

## 시스템 요구사항

### 하드웨어
- 로봇 팔 (SDK 연결)
- RealSense 카메라
- 리니어 레일 시스템

### 소프트웨어
```bash
pip install pyrealsense2 opencv-python ultralytics pillow pyzbar numpy
```

### 필수 파일
- `selector.pt`: 조정간 검사용 YOLO 모델
- `mag.pt`: 탄창 검사용 YOLO 모델
- `final_asset_rename.json`: 로봇 티칭 포지션 데이터
- `robot_sdk_v13_rail_extended.py`: 레일 확장 SDK

## 사용 방법

### 기본 실행
```bash
python mission_controller_with_vision.py
```

### 실행 시 설정 항목

1. **미션 번호** (1 or 2)
   - 1: 총기1 / 탄창1 처리
   - 2: 총기2 / 탄창2 처리

2. **방향** (in / out)
   - `in`: 불입 프로세스 (회수 및 반납)
   - `out`: 불출 프로세스 (배치 및 준비)

3. **탄창 포함 여부** (y / n)
   - `y`: 탄창을 포함하여 처리
   - `n`: 총기만 처리

4. **QR 코드 기대값** (불입 시)
   - 총기의 QR 코드가 이 값과 일치해야 함
   - 기본값: 미션 번호

5. **비전 검사 활성화** (y / n)
   - `y`: 모든 비전 검사 수행
   - `n`: 비전 검사 스킵 (테스트용)

6. **브릿지 호스트**
   - 로봇 제어기 IP 주소
   - 기본값: 192.168.1.23

## 프로세스 상세

### 불입(IN) 프로세스

```
1. 레일 인입
   └─ 레일을 내부로 완전히 당김

2. QR 코드 확인 [비전]
   ├─ RealSense로 QR 코드 촬영
   ├─ pyzbar로 디코딩
   ├─ 기대값과 비교
   └─ 불일치 시: 반출 프로세스 실행 후 종료

3. 조정간 안전 상태 확인 [비전]
   ├─ YOLO 모델로 조정간 검출
   ├─ 키포인트로 각도 계산
   ├─ SAFE 범위(110-140도) 확인
   └─ 비안전 시: 반출 프로세스 실행 후 종료

4. 탄창 처리 (with_mag=True인 경우)
   ├─ 레일에서 탄창 집기
   ├─ 비전 위치로 이동
   ├─ 탄창 방향 확인 [비전]
   │   ├─ YOLO 모델로 left_head, right_head 검출
   │   ├─ 중심점 x 좌표 비교로 방향 판단
   │   ├─ 4프레임 연속 같은 결과일 때 확정
   │   └─ 좌상탄 감지 시: 프로세스 정지
   ├─ 우상탄 확인 후 계속 진행
   └─ 보관함에 반납

5. 총기 처리
   ├─ 레일에서 총기 집기
   └─ 보관함에 반납

6. 홈 포지션 복귀
```

### 불출(OUT) 프로세스

```
1. 레일 준비
   └─ 레일이 내부에 있으면 외부로 배출

2. 총기 집기
   └─ 보관함에서 총기 픽업

3. 레일에 총기 올리기
   └─ 레일 상의 지정 위치에 배치

4. 조정간 단발 전환
   └─ 조정간을 격발 가능 상태로 회전

5. 드라이건 테스트
   ├─ 1차 장전 (7단계)
   ├─ 격발
   ├─ 2차 장전 (6단계)
   └─ 조정간을 SAFE로 전환

6. 탄창 처리 (with_mag=True인 경우)
   ├─ 보관함에서 탄창 집기
   └─ 레일에 배치

7. 홈 포지션 복귀

8. 레일 최종 배출
   └─ 사용자가 접근할 수 있도록 레일을 외부로 배출
```

## 비전 검사 상세

### 1. QR 코드 검사

**목적**: 총기 식별 및 검증

**동작**:
- pyzbar 라이브러리로 QR 코드 디코딩
- 최대 30회 시도 (약 3초)
- 실시간 검출 상태 표시

**통과 조건**:
- QR 코드가 감지됨
- 디코딩된 값이 기대값과 일치

**실패 시**:
- 경고 메시지 출력
- 자동 반출 프로세스 실행
- 프로그램 종료

### 2. 조정간 안전 검사

**목적**: 총기가 안전 상태인지 확인

**동작**:
- YOLO Pose 모델로 조정간 검출
- 2개의 키포인트(pivot, tip)로 각도 계산
- 각도를 0-180도로 정규화
- 최대 30회 시도 (약 3초)

**상태 분류**:
| 상태 | 각도 범위 | 의미 |
|------|-----------|------|
| SAFE | 110-140도 | 안전 (통과) |
| SEMI | 130-160도 | 단발 (비안전) |
| FULL | 40-80도 | 연발 (비안전) |
| BURST | 5-60도 | 점사 (비안전) |

**통과 조건**:
- 조정간이 SAFE 상태로 확인됨

**실패 시**:
- 경고 메시지 출력
- 자동 반출 프로세스 실행
- 프로그램 종료

### 3. 탄창 방향 검사

**목적**: 탄창이 올바른 방향(우상탄)인지 확인

**동작**:
- YOLO Detection 모델로 left_head, right_head 검출
- 각 클래스의 중심점 x 좌표 계산
- x 좌표 비교로 방향 판단:
  - `cx_left < cx_right` → 우상탄 (정상)
  - `cx_left > cx_right` → 좌상탄 (오류)
  - `|cx_left - cx_right| < 10` → 재확인
- 4프레임 연속 같은 결과일 때 확정
- 최대 100회 시도 (약 10초)

**통과 조건**:
- 4프레임 연속 "우상탄"으로 판정됨

**실패 시**:
- 경고 메시지 출력
- 프로세스 즉시 정지 (반출하지 않음)
- 사용자가 탄창 방향을 수동으로 확인 필요

## 단계별 실행 제어

각 단계마다 사용자 확인을 받습니다:

```
================================================================
[단계 1/10] 레일 인입
================================================================
설명: 레일을 내부로 인입합니다.

실행하시겠습니까? (y=실행, s=스킵, q=종료):
```

**입력 옵션**:
- `y`: 해당 단계 실행
- `s`: 해당 단계 건너뛰기
- `q`: 프로그램 종료

**오류 발생 시**:
- 오류 메시지 및 스택 트레이스 출력
- 재시도 옵션 제공
- 재시도 실패 시 프로그램 종료

## 설정 파일

### 비전 설정 (코드 상단)

```python
# 모델 경로
SELECTOR_MODEL_PATH = r"selector.pt"
MAG_MODEL_PATH = r"mag.pt"

# 추론 설정
VISION_CONF_THRES = 0.35  # 신뢰도 임계값
VISION_IMG_SIZE = 640      # 입력 이미지 크기
VISION_DEVICE = 'cpu'      # 'cpu' 또는 0 (GPU)

# 조정간 각도 범위
SELECTOR_RANGES = {
    "SAFE":  (110.0, 140.0),
    "SEMI":  (130.0, 160.0),
    "FULL":  (40.0,   80.0),
    "BURST": (5.0,    60.0),
}

# 탄창 검사 설정
MAG_N_CONSENSUS = 4           # 확정에 필요한 연속 프레임 수
MAG_THRESH_X_DIFF = 10.0      # 재확인 판정 임계값
MAG_THRESH_BOX_CONF = 0.50    # 박스 신뢰도 임계값
```

### 레일 설정

```python
RAIL_MAX_STROKE = 800.0        # mm
RAIL_FORWARD_SPEED = 300.0     # mm/s
RAIL_BACKWARD_SPEED = 300.0    # mm/s
RAIL_HOME_SPEED = 200.0        # mm/s
```

## 트러블슈팅

### 비전 검사 실패

**문제**: QR 코드가 인식되지 않음
- 조명 확인
- 카메라 초점 확인
- QR 코드 크기 및 거리 조정

**문제**: 조정간 상태 인식 실패
- 조정간이 카메라 시야에 완전히 들어오는지 확인
- 조명 확인
- 모델 신뢰도 임계값 조정 (`VISION_CONF_THRES`)

**문제**: 탄창 방향 인식 불안정
- `MAG_N_CONSENSUS` 값 증가 (더 많은 프레임 확인)
- `MAG_THRESH_BOX_CONF` 값 조정 (더 확실한 검출만 사용)
- 조명 및 배경 개선

### 로봇 제어 문제

**문제**: 로봇이 응답하지 않음
- 브릿지 IP 주소 확인
- 네트워크 연결 확인
- Keep-alive 간격 조정 (`KEEPALIVE_INTERVAL`)

**문제**: 레일 제어 오류
- 레일 최대 스트로크 확인
- 레일 홈 위치 재설정
- 속도 값 조정

### 프로세스 오류

**문제**: 특정 단계에서 반복적으로 실패
- 해당 단계의 티칭 포지션 확인
- `s` 키로 문제 단계 스킵하여 다음 단계 진행
- 티칭 데이터 재녹화 고려

## 주의사항

1. **안전**
   - 로봇 작동 영역에 사람이 없는지 확인
   - 비상 정지 버튼 위치 숙지
   - 첫 실행 시 느린 속도로 테스트

2. **비전 검사**
   - 카메라 렌즈 깨끗이 유지
   - 일정한 조명 환경 유지
   - 주기적으로 모델 성능 확인

3. **데이터 백업**
   - 티칭 데이터 정기적 백업
   - YOLO 모델 버전 관리
   - 설정 파일 변경 이력 관리

4. **테스트**
   - 새로운 환경에서는 비전 검사 비활성화 후 먼저 테스트
   - 단계별 실행으로 각 동작 확인
   - 문제 발생 시 즉시 `q`로 종료

## 예제 실행

### 예제 1: 총기1 불출 (탄창 포함, 비전 검사 활성화)

```
미션 번호를 선택하세요 (1 or 2): 1
방향을 선택하세요 (in=불입, out=불출): out
탄창 포함 여부 (y/n, 기본=y): y
비전 검사 활성화 (y/n, 기본=y): y
브릿지 호스트 (기본=192.168.1.23): 

[설정]
  미션: 1번
  방향: 불출(OUT)
  탄창: 포함
  비전 검사: 활성화
  브릿지: 192.168.1.23

시작하시겠습니까? (y/n): y
```

### 예제 2: 총기2 불입 (탄창 미포함, QR 검사)

```
미션 번호를 선택하세요 (1 or 2): 2
방향을 선택하세요 (in=불입, out=불출): in
탄창 포함 여부 (y/n, 기본=y): n
QR 코드 기대값 (기본=2): 2
비전 검사 활성화 (y/n, 기본=y): y
브릿지 호스트 (기본=192.168.1.23): 

[설정]
  미션: 2번
  방향: 불입(IN)
  탄창: 미포함
  QR 기대값: 2
  비전 검사: 활성화
  브릿지: 192.168.1.23

시작하시겠습니까? (y/n): y
```

### 예제 3: 테스트 모드 (비전 검사 비활성화)

```
미션 번호를 선택하세요 (1 or 2): 1
방향을 선택하세요 (in=불입, out=불출): out
탄창 포함 여부 (y/n, 기본=y): n
비전 검사 활성화 (y/n, 기본=y): n
브릿지 호스트 (기본=192.168.1.23): 

[설정]
  미션: 1번
  방향: 불출(OUT)
  탄창: 미포함
  비전 검사: 비활성화
  브릿지: 192.168.1.23

시작하시겠습니까? (y/n): y
```

## 로그 및 디버깅

### 로그 메시지 종류

- `[INFO]`: 정보성 메시지
- `[WARN]`: 경고 메시지
- `[ERROR]`: 오류 메시지
- `[VISION]`: 비전 시스템 메시지
- `[RAIL]`: 레일 제어 메시지
- `[실행]`: 프로세스 실행 메시지

### 디버깅 팁

1. **비전 검사 디버깅**
   - `display=True`로 설정되어 있어 실시간 영상 표시
   - OpenCV 창에서 검출 결과 확인 가능
   - 키프레임 저장하여 분석

2. **로봇 동작 디버깅**
   - 각 단계마다 현재 라벨 출력
   - 그리퍼 동작 로그 확인
   - 단계별 실행으로 문제 지점 특정

3. **레일 제어 디버깅**
   - 레일 위치 실시간 출력
   - 이동 결과 확인
   - 속도 및 거리 값 조정

## 업데이트 이력

### v1.0 (2025-10-27)
- 초기 버전
- QR 코드 인식 통합
- 조정간 안전 검사 통합
- 탄창 방향 검사 통합
- 자동 반출 프로세스 구현
- 단계별 실행 제어
- RealSense 카메라 지원

## 문의 및 지원

문제 발생 시:
1. 로그 메시지 확인
2. 트러블슈팅 섹션 참조
3. 설정 값 확인 및 조정
4. 필요 시 비전 검사 비활성화하여 로봇 동작만 테스트
